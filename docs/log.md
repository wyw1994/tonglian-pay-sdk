# 开发日志

## 2024-03-21
### 项目初始化
- 创建项目基础结构
- 实现统一支付接口 (unifiedOrder)
- 实现小程序链接获取功能 (appletUrl)
- 创建开发计划文档
- 创建开发日志文档

### 安全参数处理
- 新增 RequestParams 工具类
  - 支持 GET、POST、REQUEST 参数获取
  - 支持原始 POST 数据和 JSON 数据获取
  - 实现参数安全过滤
    - XSS 攻击防护
    - SQL 注入防护
    - HTML 特殊字符转义
  - 提供常用参数验证方法
    - 数字验证
    - 整数验证
    - 浮点数验证
    - URL 验证
    - 邮箱验证
    - IP 地址验证

### RequestParams 类改进
- 改为实例化方式，支持依赖注入
- 增加系统函数调用关键字过滤
- 增加 SQL 注入关键字过滤
- 增加 XSS 攻击关键字过滤
- 新增功能：
  - 支持自定义参数设置
  - 支持获取所有参数
  - 优化关键字过滤机制
  - 增加更多安全过滤规则

### RequestParams 安全机制优化
- 改进关键字过滤机制
  - 添加关键字白名单机制
  - 改为检测而非直接删除关键字
  - 对特殊字符进行转义而非删除
- 新增安全特性：
  - 系统函数调用检测
  - SQL 注入检测
  - XSS 攻击检测
  - 特殊字符转义
- 新增配置方法：
  - 支持添加允许的关键字
  - 支持添加需要转义的特殊字符
- 异常处理：
  - 检测到安全威胁时抛出异常
  - 提供清晰的错误信息

### RequestParams 类精简
- 移除冗余方法，只保留核心功能：
  - get() - 获取GET参数
  - post() - 获取POST参数
  - request() - 获取REQUEST参数
  - rawPost() - 获取原始POST数据
  - jsonPost() - 获取JSON格式的POST数据
- 简化安全过滤机制：
  - 移除复杂的关键字检测
  - 保留基本的HTML转义
  - 保留特殊字符转义
- 移除验证方法：
  - 移除各种参数验证方法
  - 由业务层自行处理参数验证
- 优化配置方法：
  - 保留参数设置方法
  - 保留特殊字符转义配置

### RequestParams JSON数据处理
- 优化参数获取机制：
  - 支持JSON格式的请求数据
  - 自动检测Content-Type
  - 解析JSON数据为数组
- 参数合并优先级：
  - POST参数 > JSON数据 > GET参数
- 新增功能：
  - 获取原始POST数据
  - 获取JSON格式的POST数据
  - 合并所有请求参数
- 优化方法：
  - 重命名params()为request()
  - 优化jsonPost()返回值类型
  - 简化参数处理逻辑

### 支付回调优化
- 优化支付回调验证机制
- 添加订单查询功能，确保订单状态一致性
- 实现业务回调处理机制
- 区分支付回调和业务处理的错误处理
- 自动返回 success 响应

### 退款回调优化
- 使用 RequestParams 获取回调数据
- 完善验证机制：
  - 签名验证
  - 商户号验证
  - 应用ID验证
  - 退款状态验证（2-退款成功、3-退款失败、6-预消费退款）
- 添加业务回调处理
- 优化错误处理机制
- 统一返回 success 响应

### 退款功能优化
- 完善退款接口参数说明
- 添加必填参数验证
- 优化参数处理：
  - 退款金额改为整数类型
  - 移除公共参数统一处理
  - 退款原因改为必填参数
- 添加分账退款支持
- 完善返回数据说明

### 退款订单查询功能
- 新增 queryRefund 方法
  - 支持通过退款订单号或商户退款单号查询
  - 完善参数验证和错误处理
  - 添加详细的返回数据说明
- 优化退款回调处理：
  - 添加退款订单查询验证
  - 验证退款状态和金额一致性
  - 合并查询结果和回调数据
  - 完善日志记录

### 退款状态处理优化
- 完善退款状态处理机制：
  - 退款成功（state=2）：记录成功日志
  - 退款失败（state=3）：抛出异常，包含错误码和错误信息
  - 退款关闭（state=4）：抛出异常，提示退款已关闭
  - 预消费退款（state=6）：记录预消费退款日志
  - 其他状态（0-订单生成，1-退款中）：记录处理中日志
- 优化错误处理：
  - 添加详细的错误信息
  - 记录完整的错误日志
  - 区分不同类型的异常

### 统一余额查询功能
- 新增 queryBalance 方法
  - 支持收银宝渠道和特色结算渠道查询
  - 完善参数验证和错误处理
  - 添加详细的返回数据说明
- 参数说明：
  - chanNo：渠道类型（allinpay/yunst2isv）
  - channelExtra：渠道参数（JSON格式）
- 返回数据：
  - amount：总余额（元）
  - cusid：子商户号（allinpay渠道）
  - availableAmt：可用余额（yunst2isv渠道）
  - transitAmt：在途余额（yunst2isv渠道）
- 优化错误处理：
  - 添加参数验证
  - 完善错误日志
  - 统一异常处理

### 对账单下载功能
- 优化 downloadBill 方法
  - 更新接口路径为 /accountstatement/getOrderFile
  - 完善参数验证和错误处理
  - 添加详细的返回数据说明
- 参数说明：
  - day：交易日期（yyyy-MM-dd格式）
  - orgId：服务商ID（选填）
- 新增功能：
  - 日期格式验证
  - 下载时间限制（D+1日11点后）
  - 文件下载和保存
- 优化错误处理：
  - 添加参数验证
  - 完善错误日志
  - 统一异常处理

## 待办事项
- [ ] 完善订单管理相关接口
- [ ] 完善账单管理功能
- [ ] 优化支付通知处理
- [ ] 增强安全性机制
- [ ] 补充项目文档
- [ ] 编写测试用例

## 2024-03-15
1. 初始化项目
   - 创建基础项目结构
   - 实现统一支付接口
   - 实现小程序链接获取功能
   - 添加 RequestParams 工具类

2. 优化 RequestParams 工具类
   - 添加安全参数处理机制
   - 实现参数过滤和验证
   - 添加白名单机制避免误删合法数据

3. 完善支付回调处理
   - 优化支付回调验证机制
   - 添加订单查询功能，确保订单状态一致性
   - 实现业务回调处理机制
   - 区分支付回调和业务处理的错误处理
   - 自动返回 success 响应 